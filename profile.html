<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="styles.css?v=3" rel="stylesheet">
    <title>My Profile - Petit Friend</title>
    <style>
        #profile-section, #auth-section { display: none; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2 fw-bold" href="index.html">
        <img src="logo.png" style="width:50px; height:50px; object-fit:cover; border-radius:20%;">
        Petit Friend
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="shop.html">Products</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
        <li class="nav-item"><a class="nav-link active" href="profile.html"><i class="bi bi-person-circle"></i> Profile</a></li>
        <li class="nav-item"><a class="btn btn-sm btn-primary ms-lg-3" href="cart.html"><i class="bi bi-bag"></i> Cart</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container py-5">
    
    <div id="auth-section" class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-sm">
                <div class="card-header bg-white text-center">
                    <ul class="nav nav-tabs card-header-tabs justify-content-center" id="authTabs">
                        <li class="nav-item"><button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-pane">Login</button></li>
                        <li class="nav-item"><button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-pane">Register</button></li>
                    </ul>
                </div>
                <div class="card-body p-4">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="login-pane">
                            <h4 class="text-center mb-4">Welcome Back!</h4>
                            <form id="login-form">
                                <div class="mb-3"><label class="form-label">Username</label><input type="text" class="form-control" id="login-username" required></div>
                                <div class="mb-3"><label class="form-label">Password</label><input type="password" class="form-control" id="login-password" required></div>
                                <button type="submit" class="btn btn-primary w-100">Login</button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="register-pane">
                            <h4 class="text-center mb-4">Create Account</h4>
                            <form id="register-form">
                                <div class="mb-3"><label class="form-label">Username</label><input type="text" class="form-control" id="reg-username" required></div>
                                <div class="mb-3"><label class="form-label">Password</label><input type="password" class="form-control" id="reg-password" required></div>
                                <button type="submit" class="btn btn-success w-100">Register</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>My Profile</h2>
            <div>
                <a href="admin.html" id="admin-panel-btn" class="btn btn-warning me-2" style="display: none;">
                    <i class="bi bi-gear-fill"></i> Admin Panel
                </a>
                
                <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
            </div>
        </div>
        
        <div class="alert alert-info" id="user-greeting">Welcome!</div>

        <div class="row g-4">
            <div class="col-lg-7">
                <form id="profile-details-form">
                    <div class="card mb-4">
                        <div class="card-header fw-bold">Personal Information</div>
                        <div class="card-body">
                            <div class="mb-3"><label class="form-label">Full Name</label><input type="text" class="form-control" id="profile-name"></div>
                            <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="profile-email"></div>
                            <div class="mb-3"><label class="form-label">Phone</label><input type="text" class="form-control" id="profile-phone"></div>
                            <div class="mb-3"><label class="form-label">Bank Card</label><input type="text" class="form-control" id="profile-card"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header fw-bold">My Pet</div>
                        <div class="card-body">
                            <div class="mb-3"><label class="form-label">Pet's Name</label><input type="text" class="form-control" id="pet-name"></div>
                            <div class="mb-3"><label class="form-label">Pet's Breed</label><input type="text" class="form-control" id="pet-breed"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4">Save Changes</button>
                </form>
            </div>
            
            <div class="col-lg-5">
                 <h3 class="mb-3">Order History</h3>
                 <div class="accordion" id="order-history"><p class="text-muted">No orders yet.</p></div>
            </div>
        </div>
    </div>

</main>

<div id="toast" class="toast align-items-center text-bg-success position-fixed bottom-0 end-0 m-3"><div class="d-flex"><div class="toast-body"></div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function() {
    
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role'); 

    if (token) {
        $('#auth-section').hide();
        $('#profile-section').fadeIn();
        
        if (role === 'admin') {
            $('#admin-panel-btn').show(); 
        }

        loadProfileData(); 
    } else {
        $('#auth-section').fadeIn();
        $('#profile-section').hide();
    }

    async function loadProfileData() {
        try {
            const response = await fetch('/api/auth/profile', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const user = await response.json();
            
            if (response.ok) {
                $('#user-greeting').text(`Welcome back, ${user.username}!`);
                
                $('#profile-name').val(user.fullName || '');
                $('#profile-email').val(user.email || '');
                $('#profile-phone').val(user.phone || '');
                $('#profile-card').val(user.card || '');
                $('#pet-name').val(user.petName || '');
                $('#pet-breed').val(user.petBreed || '');
            }
        } catch (err) {
            console.error(err);
        }
    }

    $('#profile-details-form').on('submit', async function(e) {
        e.preventDefault();
        
        const updatedData = {
            fullName: $('#profile-name').val(),
            email: $('#profile-email').val(),
            phone: $('#profile-phone').val(),
            card: $('#profile-card').val(),
            petName: $('#pet-name').val(),
            petBreed: $('#pet-breed').val()
        };

        try {
            const response = await fetch('/api/auth/profile', {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(updatedData)
            });

            if (response.ok) {
                showToast("Profile updated successfully!");
            } else {
                showToast("Failed to save.");
            }
        } catch (err) {
            showToast("Server Error.");
        }
    });

    $('#login-form').on('submit', async function(e) {
        e.preventDefault();
        const data = { username: $('#login-username').val(), password: $('#login-password').val() };

        const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();

        if (res.ok) {
            localStorage.setItem('token', result.token);
            localStorage.setItem('role', result.role); 
            location.reload();
        } else {
            showToast(result.message);
        }
    });

    $('#register-form').on('submit', async function(e) {
        e.preventDefault();
        const data = { 
            username: $('#reg-username').val(), 
            password: $('#reg-password').val() 
        };

        const res = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            showToast("Registered! Please login.");
            $('#login-tab').tab('show');
            $('#login-username').val(data.username);
        } else {
            const err = await res.json();
            showToast(err.message || "Registration failed");
        }
    });

    $('#logout-btn').click(() => {
        localStorage.clear();
        location.reload();
    });

    function showToast(msg) {
        $('#toast .toast-body').text(msg);
        new bootstrap.Toast($('#toast')).show();
    }
});
</script>

</body>
</html>