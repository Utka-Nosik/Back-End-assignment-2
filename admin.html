<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <title>Admin Panel - Petit Friend</title>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2 fw-bold" href="index.html">
        <i class="bi bi-shield-lock-fill"></i> Admin Panel
    </a>
    <div class="d-flex gap-3">
        <a href="index.html" class="btn btn-outline-light btn-sm">Go to Shop</a>
        <button id="logout-btn" class="btn btn-danger btn-sm">Logout</button>
    </div>
  </div>
</nav>

<main class="container py-5">
    <h2 class="mb-4">Shop Management</h2>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white fw-bold"><i class="bi bi-tags"></i> Add Category</div>
                <div class="card-body">
                    <form id="add-category-form">
                        <div class="mb-2"><input type="text" class="form-control" id="cat-name" placeholder="Name (e.g. Birds)" required></div>
                        <div class="mb-2"><textarea class="form-control" id="cat-desc" rows="2" placeholder="Description"></textarea></div>
                        <button type="submit" class="btn btn-primary w-100 btn-sm">Create</button>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold">Existing Categories</div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light"><tr><th>Name</th><th class="text-end">Actions</th></tr></thead>
                            <tbody id="categories-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-success text-white fw-bold"><i class="bi bi-box-seam"></i> Add Product</div>
                <div class="card-body">
                    <form id="add-product-form" class="row g-2">
                        <div class="col-md-6"><input type="text" class="form-control" id="prod-name" placeholder="Product Name" required></div>
                        <div class="col-md-3"><input type="number" class="form-control" id="prod-price" placeholder="Price" required></div>
                        <div class="col-md-3">
                            <select class="form-select" id="prod-category" required><option value="" disabled selected>Category</option></select>
                        </div>
                        <div class="col-12"><input type="url" class="form-control" id="prod-img" placeholder="Image URL"></div>
                        <div class="col-12"><textarea class="form-control" id="prod-desc" rows="1" placeholder="Description"></textarea></div>
                        <div class="col-12"><button type="submit" class="btn btn-success w-100 btn-sm">Add Product</button></div>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold">Existing Products</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">Img</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Category</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="editProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="edit-product-form">
            <input type="hidden" id="edit-prod-id">
            <div class="mb-2"><label>Name</label><input type="text" class="form-control" id="edit-prod-name" required></div>
            <div class="mb-2"><label>Price</label><input type="number" class="form-control" id="edit-prod-price" required></div>
            <div class="mb-2"><label>Category</label><select class="form-select" id="edit-prod-category" required></select></div>
            <div class="mb-2"><label>Image URL</label><input type="url" class="form-control" id="edit-prod-img"></div>
            <div class="mb-2"><label>Description</label><textarea class="form-control" id="edit-prod-desc" rows="2"></textarea></div>
            <button type="submit" class="btn btn-primary w-100 mt-2">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editCategoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="edit-category-form">
            <input type="hidden" id="edit-cat-id">
            <div class="mb-2"><label>Name</label><input type="text" class="form-control" id="edit-cat-name" required></div>
            <div class="mb-2"><label>Description</label><textarea class="form-control" id="edit-cat-desc" rows="2"></textarea></div>
            <button type="submit" class="btn btn-primary w-100 mt-2">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast align-items-center text-bg-primary position-fixed bottom-0 end-0 m-3 border-0"><div class="d-flex"><div class="toast-body"></div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(async function() {
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');

    if (!token || role !== 'admin') {
        alert("ACCESS DENIED");
        window.location.href = 'index.html';
        return;
    }

    async function loadCategories() {
        try {
            const res = await fetch('/api/v2/categories');
            const cats = await res.json();
            
            const options = '<option value="" disabled selected>Category</option>' + 
                cats.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            
            $('#prod-category').html(options);
            $('#edit-prod-category').html(options);

            $('#categories-table-body').html(cats.map(c => `
                <tr>
                    <td>
                        <div class="fw-bold">${c.name}</div>
                        <div class="small text-muted text-truncate" style="max-width: 150px;">${c.description || ''}</div>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary edit-cat-btn" 
                            data-id="${c._id}" data-name="${c.name}" data-desc="${c.description || ''}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-cat-btn" data-id="${c._id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join(''));
        } catch (e) { console.error(e); }
    }

    async function loadProducts() {
        try {
            const res = await fetch('/api/v2/items');
            const items = await res.json();

            $('#products-table-body').html(items.map(p => `
                <tr>
                    <td><img src="${p.img || 'https://via.placeholder.com/50'}" style="width:40px; height:40px; object-fit:cover; border-radius:5px;"></td>
                    <td class="fw-bold small">${p.name}</td>
                    <td>${p.price}â‚¸</td>
                    <td><span class="badge bg-secondary">${p.category}</span></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary edit-prod-btn" 
                            data-id="${p._id}" data-obj='${JSON.stringify(p)}'>
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-prod-btn" data-id="${p._id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join(''));
        } catch (e) { console.error(e); }
    }

    await loadCategories();
    await loadProducts();

    $('#add-category-form').submit(async function(e) {
        e.preventDefault();
        await apiRequest('/api/v2/categories', 'POST', {
            name: $('#cat-name').val(),
            description: $('#cat-desc').val()
        });
        $('#add-category-form')[0].reset();
        loadCategories();
    });

    $('#add-product-form').submit(async function(e) {
        e.preventDefault();
        await apiRequest('/api/v2/items', 'POST', {
            name: $('#prod-name').val(),
            price: $('#prod-price').val(),
            category: $('#prod-category').val(),
            img: $('#prod-img').val(),
            description: $('#prod-desc').val()
        });
        $('#add-product-form')[0].reset();
        loadProducts();
    });

    $(document).on('click', '.delete-cat-btn', async function() {
        if(!confirm("Delete this category?")) return;
        const id = $(this).data('id');
        await apiRequest(`/api/v2/categories/${id}`, 'DELETE');
        loadCategories();
    });

    $(document).on('click', '.delete-prod-btn', async function() {
        if(!confirm("Delete this product?")) return;
        const id = $(this).data('id');
        await apiRequest(`/api/v2/items/${id}`, 'DELETE');
        loadProducts();
    });

    $(document).on('click', '.edit-cat-btn', function() {
        const id = $(this).data('id');
        $('#edit-cat-id').val(id);
        $('#edit-cat-name').val($(this).data('name'));
        $('#edit-cat-desc').val($(this).data('desc'));
        new bootstrap.Modal('#editCategoryModal').show();
    });

    $('#edit-category-form').submit(async function(e) {
        e.preventDefault();
        const id = $('#edit-cat-id').val();
        await apiRequest(`/api/v2/categories/${id}`, 'PUT', {
            name: $('#edit-cat-name').val(),
            description: $('#edit-cat-desc').val()
        });
        bootstrap.Modal.getInstance('#editCategoryModal').hide();
        loadCategories();
    });

    $(document).on('click', '.edit-prod-btn', function() {
        const item = $(this).data('obj');
        $('#edit-prod-id').val(item._id);
        $('#edit-prod-name').val(item.name);
        $('#edit-prod-price').val(item.price);
        $('#edit-prod-category').val(item.category);
        $('#edit-prod-img').val(item.img);
        $('#edit-prod-desc').val(item.description);
        new bootstrap.Modal('#editProductModal').show();
    });

    $('#edit-product-form').submit(async function(e) {
        e.preventDefault();
        const id = $('#edit-prod-id').val();
        await apiRequest(`/api/v2/items/${id}`, 'PUT', {
            name: $('#edit-prod-name').val(),
            price: $('#edit-prod-price').val(),
            category: $('#edit-prod-category').val(),
            img: $('#edit-prod-img').val(),
            description: $('#edit-prod-desc').val()
        });
        bootstrap.Modal.getInstance('#editProductModal').hide();
        loadProducts();
    });

    async function apiRequest(url, method, body = null) {
        try {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                }
            };
            if (body) options.body = JSON.stringify(body);

            const res = await fetch(url, options);
            if (res.ok) {
                showToast("Action successful!", "success");
            } else {
                const err = await res.json();
                showToast("Error: " + err.message, "danger");
            }
        } catch (error) {
            showToast("Server error", "danger");
        }
    }

    $('#logout-btn').click(() => {
        localStorage.clear();
        window.location.href = 'index.html';
    });

    function showToast(msg, type) {
        const t = $('#toast');
        t.removeClass('text-bg-primary text-bg-success text-bg-danger').addClass('text-bg-'+type);
        t.find('.toast-body').text(msg);
        new bootstrap.Toast(t).show();
    }
});
</script>

</body>
</html>